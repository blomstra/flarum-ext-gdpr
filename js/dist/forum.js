(()=>{var t={n:r=>{var e=r&&r.__esModule?()=>r.default:()=>r;return t.d(e,{a:e}),e},d:(r,e)=>{for(var o in e)t.o(e,o)&&!t.o(r,o)&&Object.defineProperty(r,o,{enumerable:!0,get:e[o]})},o:(t,r)=>Object.prototype.hasOwnProperty.call(t,r),r:t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})}},r={};(()=>{"use strict";t.r(r),t.d(r,{extend:()=>at});const e=flarum.core.compat["forum/app"];var o=t.n(e);const a=flarum.core.compat["common/extend"],n=flarum.core.compat["common/components/Button"];var s=t.n(n);const u=flarum.core.compat["forum/components/HeaderSecondary"];var i=t.n(u);const c=flarum.core.compat["common/components/Page"];var l=t.n(c);const p=flarum.core.compat["forum/components/SettingsPage"];var d=t.n(p);function f(t,r){return f=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(t,r){return t.__proto__=r,t},f(t,r)}function h(t,r){t.prototype=Object.create(r.prototype),t.prototype.constructor=t,f(t,r)}const b=flarum.core.compat["components/Modal"];var g=t.n(b);const v=flarum.core.compat["components/Button"];var y=t.n(v),N=function(t){function r(){return t.apply(this,arguments)||this}h(r,t);var e=r.prototype;return e.className=function(){return"RequestDataModal Modal--small"},e.title=function(){return o().translator.trans("blomstra-gdpr.forum.request_data.title")},e.content=function(){return m("div",{className:"Modal-body"},m("div",{className:"Form Form--centered"},m("p",{className:"helpText"},o().translator.trans("blomstra-gdpr.forum.request_data.text")),m("div",{className:"Form-group"},y().component({className:"Button Button--primary Button--block",type:"submit",loading:this.loading},o().translator.trans("blomstra-gdpr.forum.request_data.request_button")))))},e.onsubmit=function(t){t.preventDefault(),this.loading=!0,o().request({method:"POST",url:o().forum.attribute("apiUrl")+"/gdpr/export"}).then(this.hide.bind(this),this.loaded.bind(this))},r}(g());const q=flarum.core.compat["utils/extractText"];var _=t.n(q);const w=flarum.core.compat["utils/ItemList"];var x=t.n(w);const R=flarum.core.compat["utils/Stream"];var B=t.n(R),M=function(t){function r(){return t.apply(this,arguments)||this}h(r,t);var e=r.prototype;return e.oninit=function(r){t.prototype.oninit.call(this,r),this.reason=B()(""),this.password=B()("")},e.className=function(){return"RequestErasureModal Modal--small"},e.title=function(){return app.translator.trans("blomstra-gdpr.forum.request_erasure.title")},e.content=function(){return m("div",{className:"Modal-body"},m("div",{className:"Form Form--centered"},this.fields().toArray()))},e.fields=function(){var t=this,r=new(x()),e=app.session.user.erasureRequest();return e?(r.add("status",m("div",{className:"Form-group"},m("p",{className:"helpText"},app.translator.trans("blomstra-gdpr.forum.request_erasure.status."+e.status())))),e.reason()&&r.add("reason",m("div",{className:"Form-group"},m("p",{className:"helpText"},app.translator.trans("blomstra-gdpr.forum.request_erasure.reason",{reason:e.reason()})))),r.add("cancel",m("div",{className:"Form-group"},y().component({className:"Button Button--primary Button--block",onclick:this.oncancel.bind(this),loading:this.loading},app.translator.trans("blomstra-gdpr.forum.request_erasure.cancel_button"))))):(r.add("text",m("p",{className:"helpText"},app.translator.trans("blomstra-gdpr.forum.request_erasure.text"))),r.add("password",m("div",{className:"Form-group"},m("input",{type:"password",className:"FormControl",bidi:this.password,placeholder:_()(app.translator.trans("blomstra-gdpr.forum.request_erasure.password_label"))}))),r.add("reason",m("div",{className:"Form-group"},m("textarea",{className:"FormControl",value:this.reason(),oninput:function(r){return t.reason(r.target.value)},placeholder:_()(app.translator.trans("blomstra-gdpr.forum.request_erasure.reason_label"))}))),r.add("submit",m("div",{className:"Form-group"},y().component({className:"Button Button--primary Button--block",type:"submit",loading:this.loading},app.translator.trans("blomstra-gdpr.forum.request_erasure.request_button"))))),r},e.oncancel=function(t){var r=this;this.loading=!0,m.redraw(),app.session.user.erasureRequest().delete().then((function(){r.loading=!1,m.redraw()}))},e.data=function(){return{reason:this.reason(),status:"user_confirmed",relationships:{user:app.session.user}}},e.onsubmit=function(t){var r=this;t.preventDefault(),this.loading=!0,app.store.createRecord("user-erasure-requests").save(this.data(),{meta:{password:this.password()}}).then((function(t){app.session.user.pushData({relationships:{erasureRequest:t}}),r.loading=!1,m.redraw()})).catch((function(){r.loading=!1,m.redraw()}))},r}(g());const A=flarum.core.compat["components/NotificationsDropdown"];var C=t.n(A);const F=flarum.core.compat.Component;var k=t.n(F);const O=flarum.core.compat["components/LoadingIndicator"];var S=t.n(O);const D=flarum.core.compat["helpers/avatar"];var L=t.n(D);const P=flarum.core.compat["helpers/icon"];var T=t.n(P);const j=flarum.core.compat["helpers/username"];var E=t.n(j);const z=flarum.core.compat["helpers/humanTime"];var U=t.n(z),I=function(t){function r(){return t.apply(this,arguments)||this}h(r,t);var e=r.prototype;return e.oninit=function(r){t.prototype.oninit.call(this,r),this.comments=B()(""),this.loading={}},e.className=function(){return"ProcessErasureRequestModal Modal--small"},e.title=function(){return app.translator.trans("blomstra-gdpr.forum.process_erasure.title")},e.content=function(){return m("div",{className:"Modal-body"},m("div",{className:"Form Form--centered"},this.fields().toArray()))},e.fields=function(){var t=this,r=new(x());return r.add("text",m("p",{className:"helpText"},app.translator.trans("blomstra-gdpr.forum.process_erasure.text",{name:E()(this.attrs.request.user())}))),r.add("comments",m("div",{className:"Form-group"},m("textarea",{className:"FormControl",value:this.comments(),oninput:function(r){return t.comments(r.target.value)},placeholder:_()(app.translator.trans("blomstra-gdpr.forum.process_erasure.comments_label"))}))),app.forum.attribute("erasureAnonymizationAllowed")&&r.add("anonymize",m("div",{className:"Form-group"},y().component({className:"Button Button--primary Button--block",type:"submit",loading:this.loading.anonymization,onclick:function(r){return t.onsubmit(r,"anonymization")}},app.translator.trans("blomstra-gdpr.forum.process_erasure.anonymization_button")))),app.forum.attribute("erasureDeletionAllowed")&&r.add("delete",m("div",{className:"Form-group"},y().component({className:"Button Button--danger Button--block",type:"submit",loading:this.loading.deletion,onclick:function(r){return t.onsubmit(r,"deletion")}},app.translator.trans("blomstra-gdpr.forum.process_erasure.deletion_button")))),r},e.onsubmit=function(t,r){var e=this;t.preventDefault(),confirm(app.translator.trans("blomstra-gdpr.forum.process_erasure.confirm",{name:_()(E()(this.attrs.request.user())),mode:_()(r)}))&&(this.loading[MediaSource]=!0,m.redraw(),this.attrs.request.save({processor_comment:this.comments()},{meta:{mode:r}}).then((function(t){app.store.remove(t),e.loading[MediaSource]=!1,m.redraw(),e.hide()})).catch((function(){e.loading[MediaSource]=!1,m.redraw()})))},r}(g()),G=function(t){function r(){return t.apply(this,arguments)||this}h(r,t);var e=r.prototype;return e.view=function(){var t=this,r=app.store.all("user-erasure-requests"),e=this.attrs.state;return m("div",{className:"NotificationList ErasureRequestsList"},m("div",{className:"NotificationList-header"},m("h4",{className:"App-titleControl App-titleControl--text"},app.translator.trans("blomstra-gdpr.forum.erasure_requests.title"))),m("div",{className:"NotificationList-content"},m("ul",{className:"NotificationGroup-content"},r.length?r.map((function(r){return m("li",null,m("a",{onclick:t.showModal.bind(t,r),className:"Notification Request"},L()(r.user()),T()("fas fa-user-edit",{className:"Notification-icon"}),m("span",{className:"Notification-content"},app.translator.trans("blomstra-gdpr.forum.erasure_requests.item_text",{name:E()(r.user())})),U()(r.createdAt())))})):e.loading?S().component({className:"LoadingIndicator--block"}):m("div",{className:"NotificationList-empty"},app.translator.trans("blomstra-gdpr.forum.erasure_requests.empty_text")))))},e.showModal=function(t){app.modal.show(I,{request:t})},r}(k()),H=function(t){function r(){return t.apply(this,arguments)||this}h(r,t),r.initAttrs=function(r){r.label=r.label||app.translator.trans("blomstra-gdpr.forum.erasure_requests.tooltip"),r.icon=r.icon||"fas fa-user-minus",t.initAttrs.call(this,r)};var e=r.prototype;return e.getMenu=function(){return m("div",{className:"Dropdown-menu "+this.attrs.menuClassName,onclick:this.menuClick.bind(this)},this.showing?G.component({state:this.attrs.state}):"")},e.goToRoute=function(){m.route.set(app.route("erasure-requests"))},e.getUnreadCount=function(){return this.attrs.state.requestsLoaded?app.store.all("erasure-requests").length:app.forum.attribute("erasureRequestCount")},e.getNewCount=function(){return this.getUnreadCount()},r}(C()),J=function(){function t(t){this.app=t,this.loading=!1,this.requestsLoaded=!1}return t.prototype.load=function(){var t=this;this.requestsLoaded||(this.loading=!0,m.redraw(),app.store.find("user-erasure-requests").then((function(){return t.requestsLoaded=!0}),(function(){})).then((function(){t.loading=!1,m.redraw()})))},t}();const K=flarum.core.compat["forum/components/Notification"];var Q=function(t){function r(){return t.apply(this,arguments)||this}h(r,t);var e=r.prototype;return e.icon=function(){return"fas fa-file-export"},e.href=function(){var t=this.attrs.notification.subject();return o().forum.attribute("baseUrl")+o().route("gdpr.export",{file:t.file()})},e.content=function(){return o().translator.trans("blomstra-gdpr.forum.notification.export-ready")},e.excerpt=function(){return null},r}(t.n(K)());const V=flarum.core.compat["common/extenders"];var W=t.n(V);const X=flarum.core.compat["common/models/User"];var Y=t.n(X);const Z=flarum.core.compat["common/Model"];var $=t.n(Z),tt=function(t){function r(){return t.apply(this,arguments)||this}h(r,t);var e=r.prototype;return e.status=function(){return $().attribute("status").call(this)},e.reason=function(){return $().attribute("reason").call(this)},e.createdAt=function(){return $().attribute("createdAt",$().transformDate).call(this)},e.userConfirmedAt=function(){return $().attribute("userConfirmedAt",$().transformDate).call(this)},e.processedAt=function(){return $().attribute("processedAt",$().transformDate).call(this)},e.processorComment=function(){return $().attribute("processorComment").call(this)},e.user=function(){return $().hasOne("user").call(this)},e.processedBy=function(){return $().hasOne("processedBy").call(this)},r}($());const rt=flarum.core.compat["components/Page"];var et=function(t){function r(){return t.apply(this,arguments)||this}h(r,t);var e=r.prototype;return e.oninit=function(r){t.prototype.oninit.call(this,r),app.history.push("erasure-requests"),app.erasureRequests.load(),this.bodyClass="App--ErasureRequests"},e.view=function(){return m("div",{className:"ErasureRequestsPage"},m(G,{state:app.erasureRequests}))},r}(t.n(rt)()),ot=function(t){function r(){return t.apply(this,arguments)||this}h(r,t);var e=r.prototype;return e.file=function(){return $().attribute("file").call(this)},e.destroysAt=function(){return $().attribute("destroysAt",$().transformDate)},r}($());const at=[(new(W().Store)).add("user-erasure-requests",tt).add("exports",ot),new(W().Model)(Y()).hasOne("erasureRequest"),(new(W().Routes)).add("erasure-requests","/erasure-requests",et).add("gdpr.export","/gdpr/export/:file","")];o().initializers.add("blomstra-gdpr",(function(){o().erasureRequests=new J(o()),o().notificationComponents.gdprExportAvailable=Q,(0,a.extend)(l().prototype,"oninit",(function(){m.route.param("erasureRequestConfirmed")&&o().alerts.show({type:"success"},o().translator.trans("blomstra-gdpr.forum.erasure_request_confirmed"))})),(0,a.extend)(d().prototype,"accountItems",(function(t){t.add("gdprErasure",s().component({className:"Button",onclick:function(){return o().modal.show(M)}},o().translator.trans("blomstra-gdpr.forum.settings.request_erasure_button")))})),(0,a.extend)(d().prototype,"accountItems",(function(t){t.add("gdprExport",s().component({className:"Button",onclick:function(){return o().modal.show(N)}},o().translator.trans("blomstra-gdpr.forum.settings.export_data_button")))})),(0,a.extend)(i().prototype,"items",(function(t){o().forum.attribute("erasureRequestCount")&&t.add("UsernameRequests",m(H,{state:o().erasureRequests}),20)}))}))})(),module.exports=r})();
//# sourceMappingURL=forum.js.map