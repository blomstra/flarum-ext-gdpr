(()=>{var t={n:e=>{var r=e&&e.__esModule?()=>e.default:()=>e;return t.d(r,{a:r}),r},d:(e,r)=>{for(var a in r)t.o(r,a)&&!t.o(e,a)&&Object.defineProperty(e,a,{enumerable:!0,get:r[a]})},o:(t,e)=>Object.prototype.hasOwnProperty.call(t,e),r:t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})}},e={};(()=>{"use strict";t.r(e);const r=flarum.core.compat["forum/app"];var a=t.n(r);const o=flarum.core.compat["common/extend"],s=flarum.core.compat["common/Model"];var n=t.n(s);const u=flarum.core.compat["common/components/Button"];var i=t.n(u);const c=flarum.core.compat["forum/components/HeaderSecondary"];var p=t.n(c);const l=flarum.core.compat["common/components/Page"];var d=t.n(l);const f=flarum.core.compat["forum/components/SettingsPage"];var h=t.n(f);function g(t,e){return g=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(t,e){return t.__proto__=e,t},g(t,e)}function b(t,e){t.prototype=Object.create(e.prototype),t.prototype.constructor=t,g(t,e)}const v=flarum.core.compat["components/Modal"];var y=t.n(v);const q=flarum.core.compat["components/Button"];var N=t.n(q),_=function(t){function e(){return t.apply(this,arguments)||this}b(e,t);var r=e.prototype;return r.className=function(){return"RequestDataModal Modal--small"},r.title=function(){return app.translator.trans("blomstra-gdpr.forum.request_data.title")},r.content=function(){return m("div",{className:"Modal-body"},m("div",{className:"Form Form--centered"},m("p",{className:"helpText"},app.translator.trans("blomstra-gdpr.forum.request_data.text")),m("div",{className:"Form-group"},N().component({className:"Button Button--primary Button--block",type:"submit",loading:this.loading},app.translator.trans("blomstra-gdpr.forum.request_data.request_button")))))},r.onsubmit=function(t){t.preventDefault(),this.loading=!0,app.request({method:"POST",url:app.forum.attribute("apiUrl")+"/gdpr/export"}).then(this.hide.bind(this),this.loaded.bind(this))},e}(y());const w=flarum.core.compat["utils/extractText"];var x=t.n(w);const R=flarum.core.compat["utils/ItemList"];var B=t.n(R);const M=flarum.core.compat["utils/Stream"];var C=t.n(M),F=function(t){function e(){return t.apply(this,arguments)||this}b(e,t);var r=e.prototype;return r.oninit=function(e){t.prototype.oninit.call(this,e),this.reason=C()(""),this.password=C()("")},r.className=function(){return"RequestErasureModal Modal--small"},r.title=function(){return app.translator.trans("blomstra-gdpr.forum.request_erasure.title")},r.content=function(){return m("div",{className:"Modal-body"},m("div",{className:"Form Form--centered"},this.fields().toArray()))},r.fields=function(){var t=this,e=new(B()),r=app.session.user.erasureRequest();return r?(e.add("status",m("div",{className:"Form-group"},m("p",{className:"helpText"},app.translator.trans("blomstra-gdpr.forum.request_erasure.status."+r.status())))),r.reason()&&e.add("reason",m("div",{className:"Form-group"},m("p",{className:"helpText"},app.translator.trans("blomstra-gdpr.forum.request_erasure.reason",{reason:r.reason()})))),e.add("cancel",m("div",{className:"Form-group"},N().component({className:"Button Button--primary Button--block",onclick:this.oncancel.bind(this),loading:this.loading},app.translator.trans("blomstra-gdpr.forum.request_erasure.cancel_button"))))):(e.add("text",m("p",{className:"helpText"},app.translator.trans("blomstra-gdpr.forum.request_erasure.text"))),e.add("password",m("div",{className:"Form-group"},m("input",{type:"password",className:"FormControl",bidi:this.password,placeholder:x()(app.translator.trans("blomstra-gdpr.forum.request_erasure.password_label"))}))),e.add("reason",m("div",{className:"Form-group"},m("textarea",{className:"FormControl",value:this.reason(),oninput:function(e){return t.reason(e.target.value)},placeholder:x()(app.translator.trans("blomstra-gdpr.forum.request_erasure.reason_label"))}))),e.add("submit",m("div",{className:"Form-group"},N().component({className:"Button Button--primary Button--block",type:"submit",loading:this.loading},app.translator.trans("blomstra-gdpr.forum.request_erasure.request_button"))))),e},r.oncancel=function(t){var e=this;this.loading=!0,m.redraw(),app.session.user.erasureRequest().delete().then((function(){e.loading=!1,m.redraw()}))},r.data=function(){return{reason:this.reason(),status:"user_confirmed",relationships:{user:app.session.user}}},r.onsubmit=function(t){var e=this;t.preventDefault(),this.loading=!0,app.store.createRecord("user-erasure-requests").save(this.data(),{meta:{password:this.password()}}).then((function(t){app.session.user.pushData({relationships:{erasureRequest:t}}),e.loading=!1,m.redraw()})).catch((function(){e.loading=!1,m.redraw()}))},e}(y()),A=function(t){function e(){return t.apply(this,arguments)||this}return b(e,t),e}(n());Object.assign(A.prototype,{status:n().attribute("status"),reason:n().attribute("reason"),createdAt:n().attribute("createdAt",n().transformDate),userConfirmedAt:n().attribute("userConfirmedAt",n().transformDate),processedAt:n().attribute("processedAt",n().transformDate),processorComment:n().attribute("processorComment"),user:n().hasOne("user"),processedBy:n().hasOne("processedBy")});const O=flarum.core.compat["components/Page"];var k=t.n(O);const L=flarum.core.compat.Component;var P=t.n(L);const S=flarum.core.compat["components/LoadingIndicator"];var D=t.n(S);const T=flarum.core.compat["helpers/avatar"];var j=t.n(T);const E=flarum.core.compat["helpers/icon"];var z=t.n(E);const I=flarum.core.compat["helpers/username"];var U=t.n(I);const G=flarum.core.compat["helpers/humanTime"];var H=t.n(G),J=function(t){function e(){return t.apply(this,arguments)||this}b(e,t);var r=e.prototype;return r.oninit=function(e){t.prototype.oninit.call(this,e),this.comments=C()(""),this.loading={}},r.className=function(){return"ProcessErasureRequestModal Modal--small"},r.title=function(){return app.translator.trans("blomstra-gdpr.forum.process_erasure.title")},r.content=function(){return m("div",{className:"Modal-body"},m("div",{className:"Form Form--centered"},this.fields().toArray()))},r.fields=function(){var t=this,e=new(B());return e.add("text",m("p",{className:"helpText"},app.translator.trans("blomstra-gdpr.forum.process_erasure.text",{name:U()(this.attrs.request.user())}))),e.add("comments",m("div",{className:"Form-group"},m("textarea",{className:"FormControl",value:this.comments(),oninput:function(e){return t.comments(e.target.value)},placeholder:x()(app.translator.trans("blomstra-gdpr.forum.process_erasure.comments_label"))}))),app.forum.attribute("erasureAnonymizationAllowed")&&e.add("anonymize",m("div",{className:"Form-group"},N().component({className:"Button Button--primary Button--block",type:"submit",loading:this.loading.anonymization,onclick:function(e){return t.onsubmit(e,"anonymization")}},app.translator.trans("blomstra-gdpr.forum.process_erasure.anonymization_button")))),app.forum.attribute("erasureDeletionAllowed")&&e.add("delete",m("div",{className:"Form-group"},N().component({className:"Button Button--danger Button--block",type:"submit",loading:this.loading.deletion,onclick:function(e){return t.onsubmit(e,"deletion")}},app.translator.trans("blomstra-gdpr.forum.process_erasure.deletion_button")))),e},r.onsubmit=function(t,e){var r=this;t.preventDefault(),confirm(app.translator.trans("blomstra-gdpr.forum.process_erasure.confirm",{name:x()(U()(this.attrs.request.user())),mode:x()(e)}))&&(this.loading[MediaSource]=!0,m.redraw(),this.attrs.request.save({processor_comment:this.comments()},{meta:{mode:e}}).then((function(t){app.store.remove(t),r.loading[MediaSource]=!1,m.redraw(),r.hide()})).catch((function(){r.loading[MediaSource]=!1,m.redraw()})))},e}(y()),K=function(t){function e(){return t.apply(this,arguments)||this}b(e,t);var r=e.prototype;return r.view=function(){var t=this,e=app.store.all("user-erasure-requests"),r=this.attrs.state;return m("div",{className:"NotificationList ErasureRequestsList"},m("div",{className:"NotificationList-header"},m("h4",{className:"App-titleControl App-titleControl--text"},app.translator.trans("blomstra-gdpr.forum.erasure_requests.title"))),m("div",{className:"NotificationList-content"},m("ul",{className:"NotificationGroup-content"},e.length?e.map((function(e){return m("li",null,m("a",{onclick:t.showModal.bind(t,e),className:"Notification Request"},j()(e.user()),z()("fas fa-user-edit",{className:"Notification-icon"}),m("span",{className:"Notification-content"},app.translator.trans("blomstra-gdpr.forum.erasure_requests.item_text",{name:U()(e.user())})),H()(e.createdAt())))})):r.loading?D().component({className:"LoadingIndicator--block"}):m("div",{className:"NotificationList-empty"},app.translator.trans("blomstra-gdpr.forum.erasure_requests.empty_text")))))},r.showModal=function(t){app.modal.show(J,{request:t})},e}(P()),Q=function(t){function e(){return t.apply(this,arguments)||this}b(e,t);var r=e.prototype;return r.oninit=function(e){t.prototype.oninit.call(this,e),app.history.push("erasure-requests"),app.erasureRequests.load(),this.bodyClass="App--ErasureRequests"},r.view=function(){return m("div",{className:"ErasureRequestsPage"},m(K,{state:app.erasureRequests}))},e}(k());const V=flarum.core.compat["components/NotificationsDropdown"];var W=function(t){function e(){return t.apply(this,arguments)||this}b(e,t),e.initAttrs=function(e){e.label=e.label||app.translator.trans("blomstra-gdpr.forum.erasure_requests.tooltip"),e.icon=e.icon||"fas fa-user-minus",t.initAttrs.call(this,e)};var r=e.prototype;return r.getMenu=function(){return m("div",{className:"Dropdown-menu "+this.attrs.menuClassName,onclick:this.menuClick.bind(this)},this.showing?K.component({state:this.attrs.state}):"")},r.goToRoute=function(){m.route.set(app.route("erasure-requests"))},r.getUnreadCount=function(){return this.attrs.state.requestsLoaded?app.store.all("erasure-requests").length:app.forum.attribute("erasureRequestCount")},r.getNewCount=function(){return this.getUnreadCount()},e}(t.n(V)()),X=function(){function t(t){this.app=t,this.loading=!1,this.requestsLoaded=!1}return t.prototype.load=function(){var t=this;this.requestsLoaded||(this.loading=!0,m.redraw(),app.store.find("user-erasure-requests").then((function(){return t.requestsLoaded=!0}),(function(){})).then((function(){t.loading=!1,m.redraw()})))},t}();a().initializers.add("blomstra-gdpr",(function(){a().store.models["user-erasure-requests"]=A,a().store.models.users.prototype.erasureRequest=n().hasOne("erasureRequest"),a().routes["erasure-requests"]={path:"/erasure-requests",component:Q},a().erasureRequests=new X(a()),(0,o.extend)(d().prototype,"oninit",(function(){m.route.param("erasureRequestConfirmed")&&a().alerts.show({type:"success"},a().translator.trans("blomstra-gdpr.forum.erasure_request_confirmed"))})),(0,o.extend)(h().prototype,"accountItems",(function(t){t.add("gdprErasure",i().component({className:"Button",onclick:function(){return a().modal.show(F)}},a().translator.trans("blomstra-gdpr.forum.settings.request_erasure_button")))})),(0,o.extend)(h().prototype,"accountItems",(function(t){t.add("gdprExport",i().component({className:"Button",onclick:function(){return a().modal.show(_)}},a().translator.trans("blomstra-gdpr.forum.settings.export_data_button")))})),(0,o.extend)(p().prototype,"items",(function(t){a().forum.attribute("erasureRequestCount")&&t.add("UsernameRequests",m(W,{state:a().erasureRequests}),20)}))}))})(),module.exports=e})();
//# sourceMappingURL=forum.js.map