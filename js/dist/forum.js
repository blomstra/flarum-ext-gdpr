(()=>{var t={n:r=>{var e=r&&r.__esModule?()=>r.default:()=>r;return t.d(e,{a:e}),e},d:(r,e)=>{for(var o in e)t.o(e,o)&&!t.o(r,o)&&Object.defineProperty(r,o,{enumerable:!0,get:e[o]})},o:(t,r)=>Object.prototype.hasOwnProperty.call(t,r),r:t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})}},r={};(()=>{"use strict";t.r(r),t.d(r,{extend:()=>ot});const e=flarum.core.compat["forum/app"];var o=t.n(e);const a=flarum.core.compat["common/extend"],s=flarum.core.compat["forum/components/HeaderSecondary"];var n=t.n(s);const u=flarum.core.compat["common/components/Page"];var i=t.n(u);function c(t,r){return c=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(t,r){return t.__proto__=r,t},c(t,r)}function l(t,r){t.prototype=Object.create(r.prototype),t.prototype.constructor=t,c(t,r)}const d=flarum.core.compat["common/components/NotificationsDropdown"];var p=t.n(d);const f=flarum.core.compat["common/Component"];var h=t.n(f);const g=flarum.core.compat["common/components/LoadingIndicator"];var b=t.n(g);const v=flarum.core.compat["common/helpers/avatar"];var y=t.n(v);const N=flarum.core.compat["common/helpers/icon"];var q=t.n(N);const _=flarum.core.compat["common/helpers/username"];var x=t.n(_);const w=flarum.core.compat["common/helpers/humanTime"];var B=t.n(w);const R=flarum.core.compat["common/components/Modal"];var A=t.n(R);const M=flarum.core.compat["common/components/Button"];var C=t.n(M);const F=flarum.core.compat["common/utils/extractText"];var S=t.n(F);const k=flarum.core.compat["common/utils/ItemList"];var O=t.n(k);const T=flarum.core.compat["common/utils/Stream"];var D=t.n(T),E=function(t){function r(){return t.apply(this,arguments)||this}l(r,t);var e=r.prototype;return e.oninit=function(r){t.prototype.oninit.call(this,r),this.comments=D()(""),this.loading={}},e.className=function(){return"ProcessErasureRequestModal Modal--small"},e.title=function(){return o().translator.trans("blomstra-gdpr.forum.process_erasure.title")},e.content=function(){return m("div",{className:"Modal-body"},m("div",{className:"Form Form--centered"},this.fields().toArray()))},e.fields=function(){var t=this,r=new(O());return r.add("text",m("p",{className:"helpText"},o().translator.trans("blomstra-gdpr.forum.process_erasure.text",{name:x()(this.attrs.request.user())}))),r.add("comments",m("div",{className:"Form-group"},m("textarea",{className:"FormControl",value:this.comments(),oninput:function(r){return t.comments(r.target.value)},placeholder:S()(o().translator.trans("blomstra-gdpr.forum.process_erasure.comments_label"))}))),o().forum.attribute("erasureAnonymizationAllowed")&&r.add("anonymize",m("div",{className:"Form-group"},C().component({className:"Button Button--primary Button--block",type:"submit",loading:this.loading.anonymization,onclick:function(r){return t.onsubmit(r,"anonymization")}},o().translator.trans("blomstra-gdpr.forum.process_erasure.anonymization_button")))),o().forum.attribute("erasureDeletionAllowed")&&r.add("delete",m("div",{className:"Form-group"},C().component({className:"Button Button--danger Button--block",type:"submit",loading:this.loading.deletion,onclick:function(r){return t.onsubmit(r,"deletion")}},o().translator.trans("blomstra-gdpr.forum.process_erasure.deletion_button")))),r},e.onsubmit=function(t,r){var e=this;t.preventDefault(),confirm(o().translator.trans("blomstra-gdpr.forum.process_erasure.confirm",{name:S()(x()(this.attrs.request.user())),mode:S()(r)}))&&(this.loading[MediaSource]=!0,m.redraw(),this.attrs.request.save({processor_comment:this.comments()},{meta:{mode:r}}).then((function(t){o().store.remove(t),e.loading[MediaSource]=!1,m.redraw(),e.hide()})).catch((function(){e.loading[MediaSource]=!1,m.redraw()})))},r}(A()),L=function(t){function r(){return t.apply(this,arguments)||this}l(r,t);var e=r.prototype;return e.view=function(){var t=this,r=o().store.all("user-erasure-requests"),e=this.attrs.state;return m("div",{className:"NotificationList ErasureRequestsList"},m("div",{className:"NotificationList-header"},m("h4",{className:"App-titleControl App-titleControl--text"},o().translator.trans("blomstra-gdpr.forum.erasure_requests.title"))),m("div",{className:"NotificationList-content"},m("ul",{className:"NotificationGroup-content"},r.length?r.map((function(r){return m("li",null,m("a",{onclick:t.showModal.bind(t,r),className:"Notification Request"},y()(r.user()),q()("fas fa-user-edit",{className:"Notification-icon"}),m("span",{className:"Notification-content"},o().translator.trans("blomstra-gdpr.forum.erasure_requests.item_text",{name:x()(r.user())})),B()(r.createdAt())))})):e.loading?b().component({className:"LoadingIndicator--block"}):m("div",{className:"NotificationList-empty"},o().translator.trans("blomstra-gdpr.forum.erasure_requests.empty_text")))))},e.showModal=function(t){o().modal.show(E,{request:t})},r}(h()),P=function(t){function r(){return t.apply(this,arguments)||this}l(r,t),r.initAttrs=function(r){r.label=r.label||o().translator.trans("blomstra-gdpr.forum.erasure_requests.tooltip"),r.icon=r.icon||"fas fa-user-minus",t.initAttrs.call(this,r)};var e=r.prototype;return e.getMenu=function(){return m("div",{className:"Dropdown-menu "+this.attrs.menuClassName,onclick:this.menuClick.bind(this)},this.showing?L.component({state:this.attrs.state}):"")},e.goToRoute=function(){m.route.set(o().route("erasure-requests"))},e.getUnreadCount=function(){return this.attrs.state.requestsLoaded?o().store.all("erasure-requests").length:o().forum.attribute("erasureRequestCount")},e.getNewCount=function(){return this.getUnreadCount()},r}(p()),j=function(){function t(t){this.app=t,this.loading=!1,this.requestsLoaded=!1}return t.prototype.load=function(){var t=this;this.requestsLoaded||(this.loading=!0,m.redraw(),app.store.find("user-erasure-requests").then((function(){return t.requestsLoaded=!0}),(function(){})).then((function(){t.loading=!1,m.redraw()})))},t}();const I=flarum.core.compat["forum/components/Notification"];var z=function(t){function r(){return t.apply(this,arguments)||this}l(r,t);var e=r.prototype;return e.icon=function(){return"fas fa-file-export"},e.href=function(){var t=this.attrs.notification.subject();return o().forum.attribute("baseUrl")+o().route("gdpr.export",{file:t.file()})},e.content=function(){return o().translator.trans("blomstra-gdpr.forum.notification.export-ready")},e.excerpt=function(){return null},r}(t.n(I)());const U=flarum.core.compat["forum/components/SettingsPage"];var G=t.n(U);const H=flarum.core.compat["common/components/FieldSet"];var J=t.n(H),K=function(t){function r(){return t.apply(this,arguments)||this}l(r,t);var e=r.prototype;return e.oninit=function(r){t.prototype.oninit.call(this,r),this.reason=D()(""),this.password=D()("")},e.className=function(){return"RequestErasureModal Modal--small"},e.title=function(){return o().translator.trans("blomstra-gdpr.forum.request_erasure.title")},e.content=function(){return m("div",{className:"Modal-body"},m("div",{className:"Form Form--centered"},this.fields().toArray()))},e.fields=function(){var t=this,r=new(O()),e=o().session.user.erasureRequest();return e?(r.add("status",m("div",{className:"Form-group"},m("p",{className:"helpText"},o().translator.trans("blomstra-gdpr.forum.request_erasure.status."+e.status())))),e.reason()&&r.add("reason",m("div",{className:"Form-group"},m("p",{className:"helpText"},o().translator.trans("blomstra-gdpr.forum.request_erasure.reason",{reason:e.reason()})))),r.add("cancel",m("div",{className:"Form-group"},C().component({className:"Button Button--primary Button--block",onclick:this.oncancel.bind(this),loading:this.loading},o().translator.trans("blomstra-gdpr.forum.request_erasure.cancel_button"))))):(r.add("text",m("p",{className:"helpText"},o().translator.trans("blomstra-gdpr.forum.request_erasure.text"))),r.add("password",m("div",{className:"Form-group"},m("input",{type:"password",className:"FormControl",bidi:this.password,placeholder:S()(o().translator.trans("blomstra-gdpr.forum.request_erasure.password_label"))}))),r.add("reason",m("div",{className:"Form-group"},m("textarea",{className:"FormControl",value:this.reason(),oninput:function(r){return t.reason(r.target.value)},placeholder:S()(o().translator.trans("blomstra-gdpr.forum.request_erasure.reason_label"))}))),r.add("submit",m("div",{className:"Form-group"},C().component({className:"Button Button--primary Button--block",type:"submit",loading:this.loading},o().translator.trans("blomstra-gdpr.forum.request_erasure.request_button"))))),r},e.oncancel=function(t){var r=this;this.loading=!0,m.redraw(),o().session.user.erasureRequest().delete().then((function(){r.loading=!1,m.redraw()}))},e.data=function(){return{reason:this.reason(),status:"user_confirmed",relationships:{user:o().session.user}}},e.onsubmit=function(t){var r=this;t.preventDefault(),this.loading=!0,o().store.createRecord("user-erasure-requests").save(this.data(),{meta:{password:this.password()}}).then((function(t){o().session.user.pushData({relationships:{erasureRequest:t}}),r.loading=!1,m.redraw()})).catch((function(){r.loading=!1,m.redraw()}))},r}(A()),Q=function(t){function r(){return t.apply(this,arguments)||this}l(r,t);var e=r.prototype;return e.className=function(){return"RequestDataModal Modal--small"},e.title=function(){return o().translator.trans("blomstra-gdpr.forum.request_data.title")},e.content=function(){return m("div",{className:"Modal-body"},m("div",{className:"Form Form--centered"},m("p",{className:"helpText"},o().translator.trans("blomstra-gdpr.forum.request_data.text")),m("div",{className:"Form-group"},C().component({className:"Button Button--primary Button--block",type:"submit",loading:this.loading},o().translator.trans("blomstra-gdpr.forum.request_data.request_button")))))},e.onsubmit=function(t){t.preventDefault(),this.loading=!0,o().request({method:"POST",url:o().forum.attribute("apiUrl")+"/gdpr/export"}).then(this.hide.bind(this),this.loaded.bind(this))},r}(A());const V=flarum.core.compat["common/extenders"];var W=t.n(V);const X=flarum.core.compat["common/models/User"];var Y=t.n(X);const Z=flarum.core.compat["common/Model"];var $=t.n(Z),tt=function(t){function r(){return t.apply(this,arguments)||this}l(r,t);var e=r.prototype;return e.status=function(){return $().attribute("status").call(this)},e.reason=function(){return $().attribute("reason").call(this)},e.createdAt=function(){return $().attribute("createdAt",$().transformDate).call(this)},e.userConfirmedAt=function(){return $().attribute("userConfirmedAt",$().transformDate).call(this)},e.processedAt=function(){return $().attribute("processedAt",$().transformDate).call(this)},e.processorComment=function(){return $().attribute("processorComment").call(this)},e.user=function(){return $().hasOne("user").call(this)},e.processedBy=function(){return $().hasOne("processedBy").call(this)},r}($()),rt=function(t){function r(){return t.apply(this,arguments)||this}l(r,t);var e=r.prototype;return e.oninit=function(r){t.prototype.oninit.call(this,r),o().history.push("erasure-requests"),o().erasureRequests.load(),this.bodyClass="App--ErasureRequests"},e.view=function(){return m("div",{className:"ErasureRequestsPage"},m(L,{state:o().erasureRequests}))},r}(i()),et=function(t){function r(){return t.apply(this,arguments)||this}l(r,t);var e=r.prototype;return e.file=function(){return $().attribute("file").call(this)},e.destroysAt=function(){return $().attribute("destroysAt",$().transformDate)},r}($());const ot=[(new(W().Store)).add("user-erasure-requests",tt).add("exports",et),new(W().Model)(Y()).hasOne("erasureRequest"),(new(W().Routes)).add("erasure-requests","/erasure-requests",rt).add("gdpr.export","/gdpr/export/:file","")];o().initializers.add("blomstra-gdpr",(function(){o().erasureRequests=new j(o()),o().notificationComponents.gdprExportAvailable=z,(0,a.extend)(G().prototype,"settingsItems",(function(t){this.user&&t.add("dataItems",m(J(),{className:"Settings-gdpr",label:o().translator.trans("blomstra-gdpr.forum.settings.data.heading")},this.dataItems().toArray()),90)})),G().prototype.dataItems=function(){var t=new(O());return t.add("gdprErasure",m("div",{className:"gdprErasure-container"},m(C(),{className:"Button Button-gdprErasure",icon:"fas fa-user-minus",onclick:function(){return o().modal.show(K)}},o().translator.trans("blomstra-gdpr.forum.settings.request_erasure_button")),m("p",{className:"helpText"},o().translator.trans("blomstra-gdpr.forum.settings.request_erasure_help"))),50),t.add("gdprExport",m("div",{className:"gdprExport-container"},m(C(),{className:"Button Button-gdprExport",icon:"fas fa-file-export",onclick:function(){return o().modal.show(Q)}},o().translator.trans("blomstra-gdpr.forum.settings.export_data_button")),m("p",{className:"helpText"},o().translator.trans("blomstra-gdpr.forum.settings.export_data_help"))),40),t},(0,a.extend)(i().prototype,"oninit",(function(){m.route.param("erasureRequestConfirmed")&&o().alerts.show({type:"success"},o().translator.trans("blomstra-gdpr.forum.erasure_request_confirmed"))})),(0,a.extend)(n().prototype,"items",(function(t){o().forum.attribute("erasureRequestCount")&&t.add("UsernameRequests",m(P,{state:o().erasureRequests}),20)}))}))})(),module.exports=r})();
//# sourceMappingURL=forum.js.map